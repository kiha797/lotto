<!DOCTYPE html>
<html lang="ko">
    <head>
        <title>로또 추첨기 By 빅데이터</title>
        <meta name="viewport" content="width=device-width, height=580, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="style.css">
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-6132e4b7572ac9b6"></script>
        <script type="text/javascript" src="https://webqr.com/llqrcode.js"></script>
        </head>
<body>
<!--스캐너 시작-->
<div id="wrapper">
    <h1 id="title">로또 당첨 스캐너</h1>
    <div id="main">
        <div id="header">
        <div style="position:relative;top:+20px;left:0px;">
        
        </div>
        <div id="mainbody">
        <table class="tsel" border="0" width="100%">
        <tr>
        <td valign="top" align="center" width="50%">
        <table class="tsel" border="0">
        <tr>
        <td><img class="selector" id="webcamimg" src="https://webqr.com/vid.png" onclick="setwebcam()" align="left" /></td>
        <td><img class="selector" id="qrimg" src="https://webqr.com/cam.png" onclick="setimg()" align="right"/></td></tr>
        <tr><td colspan="2" align="center">
        <div id="outdiv">
        </div></td></tr>
        </table>
        </td>
        </tr>
        
        <tr><td colspan="3" align="center">
        <div id="result"></div>
        </td></tr>
        </table>
        
        <!-- webqr_2016 -->
        
        </div>&nbsp;
        <div id="footer">
        
        <h5 align="center">Filigreen</h5>
        </div>
        </div>
        <canvas id="qr-canvas" width="800" height="600"></canvas>

<script>
var gCtx = null;
var gCanvas = null;
var c=0;
var stype=0;
var gUM=false;
var webkit=false;
var moz=false;
var v=null;

var imghtml='<div id="qrfile"><canvas id="out-canvas" width="320" height="240"></canvas>'+
    '<div id="imghelp">drag and drop a QRCode here'+
    '<br>or select a file'+
    '<input type="file" onchange="handleFiles(this.files)"/>'+
    '</div>'+
'</div>';

var vidhtml = '<video id="v" autoplay></video>';

function dragenter(e) {
e.stopPropagation();
e.preventDefault();
}

function dragover(e) {
e.stopPropagation();
e.preventDefault();
}
function drop(e) {
e.stopPropagation();
e.preventDefault();

var dt = e.dataTransfer;
var files = dt.files;
if(files.length>0)
{
handleFiles(files);
}
else
if(dt.getData('URL'))
{
qrcode.decode(dt.getData('URL'));
}
}

function handleFiles(f)
{
var o=[];

for(var i =0;i<f.length;i++)
{
    var reader = new FileReader();
    reader.onload = (function(theFile) {
    return function(e) {
        gCtx.clearRect(0, 0, gCanvas.width, gCanvas.height);

        qrcode.decode(e.target.result);
    };
    })(f[i]);
    reader.readAsDataURL(f[i]);	
}
}

function initCanvas(w,h)
{
gCanvas = document.getElementById("qr-canvas");
gCanvas.style.width = w + "px";
gCanvas.style.height = h + "px";
gCanvas.width = w;
gCanvas.height = h;
gCtx = gCanvas.getContext("2d");
gCtx.clearRect(0, 0, w, h);
console.log('gCtx',gCtx);
}


function captureToCanvas() {
if(stype!=1)
    return;
if(gUM)
{
    try{
        gCtx.drawImage(v,0,0);
        try{
            qrcode.decode();
        }
        catch(e){       
            console.log(e);
            setTimeout(captureToCanvas, 500);
        };
    }
    catch(e){       
            console.log(e);
            setTimeout(captureToCanvas, 500);
    };
}
}

function htmlEntities(str) {
return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function read(a)
{
var html="<br>";
if(a.indexOf("http://") === 0 || a.indexOf("https://") === 0)
    html+="<a target='_blank' href='"+a+"'>"+a+"</a><br>";
html+="<b>"+htmlEntities(a)+"</b><br><br>";
document.getElementById("result").innerHTML=html;
}	

function isCanvasSupported(){
var elem = document.createElement('canvas');
return !!(elem.getContext && elem.getContext('2d'));
}
function success(stream) 
{

v.srcObject = stream;
v.play();

gUM=true;
setTimeout(captureToCanvas, 500);
}
    
function error(error)
{
gUM=false;
return;
}

function load()
{
if(isCanvasSupported() && window.File && window.FileReader)
{
    initCanvas(800, 600);
    qrcode.callback = read;
    document.getElementById("mainbody").style.display="inline";
    setwebcam();
}
else
{
    document.getElementById("mainbody").style.display="inline";
    document.getElementById("mainbody").innerHTML='<p id="mp1">QR code scanner for HTML5 capable browsers</p><br>'+
    '<br><p id="mp2">sorry your browser is not supported</p><br><br>'+
    '<p id="mp1">try <a href="http://www.mozilla.com/firefox"><img src="firefox.png"/></a> or <a href="http://chrome.google.com"><img src="chrome_logo.gif"/></a> or <a href="http://www.opera.com"><img src="Opera-logo.png"/></a></p>';
}
}

function setwebcam()
{

var options = true;
if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices)
{
    try{
        navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
          devices.forEach(function(device) {
            if (device.kind === 'videoinput') {
              if(device.label.toLowerCase().search("back") >-1)
                options={'deviceId': {'exact':device.deviceId}, 'facingMode':'environment'} ;
            }
            console.log(device.kind + ": " + device.label +" id = " + device.deviceId);
          });
          setwebcam2(options);
        });
    }
    catch(e)
    {
        console.log(e);
    }
}
else{
    console.log("no navigator.mediaDevices.enumerateDevices" );
    setwebcam2(options);
}

}

function setwebcam2(options)
{
console.log(options);
document.getElementById("result").innerHTML="- scanning -";
if(stype==1)
{
    setTimeout(captureToCanvas, 500);    
    return;
}
var n=navigator;
document.getElementById("outdiv").innerHTML = vidhtml;
v=document.getElementById("v");


if(n.mediaDevices.getUserMedia)
{
    n.mediaDevices.getUserMedia({video: options, audio: false}).
        then(function(stream){
            success(stream);
        }).catch(function(error){
            error(error)
        });
}
else
if(n.getUserMedia)
{
    webkit=true;
    n.getUserMedia({video: options, audio: false}, success, error);
}
else
if(n.webkitGetUserMedia)
{
    webkit=true;
    n.webkitGetUserMedia({video:options, audio: false}, success, error);
}

document.getElementById("qrimg").style.opacity=0.2;
document.getElementById("webcamimg").style.opacity=1.0;

stype=1;
setTimeout(captureToCanvas, 500);
}

function setimg()
{
document.getElementById("result").innerHTML="";
if(stype==2)
    return;
document.getElementById("outdiv").innerHTML = imghtml;
document.getElementById("qrimg").style.opacity=1.0;
document.getElementById("webcamimg").style.opacity=0.2;
var qrfile = document.getElementById("qrfile");
qrfile.addEventListener("dragenter", dragenter, false);  
qrfile.addEventListener("dragover", dragover, false);  
qrfile.addEventListener("drop", drop, false);
stype=2;
}

load();
</script>
          </div>
    </div>
<!--스캐너 끝>
    </body>
</html>
